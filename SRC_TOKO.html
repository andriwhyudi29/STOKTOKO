<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>StokToko</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fff; color:#333; }
    header { background:#d43f3f; color:#fff; padding:14px; display:flex; justify-content:space-between; align-items:center; }
    header .left { font-size:20px; font-weight:bold; }
    header .right { position:relative; }
    #cartCountTag { background:#fff; color:#d43f3f; border-radius:50%; padding:2px 6px; font-size:12px; position:absolute; top:-6px; right:-6px; }
    .btn { background:#d43f3f; color:#fff; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; }
    .btn:hover { opacity:0.9; }
    .btn-secondary { background:#777; color:#fff; }
    .btn-outline { background:#fff; border:1px solid #d43f3f; color:#d43f3f; }
    .btn-small { font-size:14px; padding:6px 10px; border-radius:4px; }
    .row { display:flex; gap:10px; }
    .input { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-top:6px; }
    .category { border:1px solid #eee; border-radius:6px; margin:8px 0; }
    .category-header { padding:10px; background:#f5f5f5; font-weight:bold; cursor:pointer; display:flex; justify-content:space-between; }
    .category-products { display:none; padding:10px; }
    .product { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .product img { width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }
    .product-info { flex:1; }
    .plus { background:#d43f3f; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:18px; cursor:pointer; }
    .bottom-nav { position:fixed; bottom:0; left:0; right:0; display:flex; border-top:1px solid #ddd; background:#fff; }
    .nav-item { flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:bold; }
    .nav-item.active { color:#d43f3f; }
    .overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
    .popup { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
    .empty { text-align:center; padding:20px; color:#777; }
    .cart-item { display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:8px 0; }
    .cart-item img { width:50px; height:50px; object-fit:cover; border-radius:6px; border:1px solid #ddd; }
    .cart-info { flex:1; }
    pre { background:#fafafa; padding:6px; border-radius:6px; font-size:14px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="left">ğŸ“¦ STOKTOKO</div>
    <div class="right">
      <button id="cartIconBtn" class="icon-btn" style="background:none;border:none;cursor:pointer;">
        ğŸ›’
      </button>
      <span id="cartCountTag">0</span>
    </div>
  </header>

  <!-- Halaman -->
  <main style="padding:14px; margin-bottom:70px;">
    <!-- Home -->
    <section id="homePage">
      <div class="row" style="margin-bottom:18px;">
        <button id="addProductBtn" class="btn" style="flex:1;">â• Tambah Produk</button>
        <button id="outOfStockBtn" class="btn btn-secondary" style="flex:1;">âš ï¸ Barang Kosong</button>
      </div>

      <h3>ğŸ“‚ Daftar Kategori</h3>
      <div id="categoriesList"></div>
    </section>

    <!-- Cart -->
    <section id="cartPage" style="display:none;">
      <h3>ğŸ›’ Keranjang Belanja</h3>
      <div class="row" style="margin:10px 0;">
        <label><input type="checkbox" id="selectAllCart"> Pilih Semua</label>
      </div>
      <div id="cartList"></div>
      <div class="row" style="margin-top:16px;gap:10px;">
        <button id="checkoutBtn" class="btn" style="flex:1;">Checkout</button>
        <button id="deleteCheckedBtn" class="btn btn-secondary" style="flex:1;">Hapus</button>
      </div>
      <div style="margin-top:14px;">
        <button id="backHomeBtn" class="btn btn-outline" style="width:100%;">â¬…ï¸ Kembali</button>
      </div>
    </section>

    <!-- Orders -->
    <section id="ordersPage" style="display:none;">
      <h3>ğŸ“‹ Pesanan Pending</h3>
      <div id="orderList"></div>

      <h3 style="margin-top:20px;">â• Tambah Pesanan Manual</h3>
      <input id="custNameInput" class="input" placeholder="Nama Pelanggan">
      <input id="custWaInput" class="input" placeholder="Nomor WA (opsional)">
      <input id="custDateInput" class="input" placeholder="Tanggal/Hari Pengambilan">

      <!-- Textarea dengan auto-bullet -->
      <textarea id="custOrderInput" class="input" rows="4" placeholder="Pesanan (contoh: 
â€¢ Roti 5 dus
â€¢ Air 3 bal)"></textarea>

      <button id="addOrderBtn" class="btn" style="margin-top:10px;width:100%;">+ Tambah Pesanan</button>

      <div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center;">
        <h3>ğŸ“œ Riwayat Pesanan</h3>
        <button id="openHistoryBtn" class="btn-small btn-outline">Lihat Semua</button>
      </div>
      <div id="historyList"></div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div id="navHome" class="nav-item active">ğŸ  Home</div>
    <div id="navOrders" class="nav-item">ğŸ“‹ Pesanan</div>
  </div>
  <!-- Popup: Tambah/Edit Produk -->
  <div id="addProductOverlay" class="overlay">
    <div class="popup">
      <h3 id="addEditTitle">Tambah Produk</h3>
      <input id="productIdHidden" type="hidden">
      <input id="productName" class="input" placeholder="Nama Produk" style="margin-top:10px;">
      <input id="productCategory" class="input" placeholder="Kategori" style="margin-top:10px;">
      <input id="productStock" class="input" type="number" placeholder="Stok" style="margin-top:10px;">
      <input id="productImage" class="input" type="file" accept="image/*" style="margin-top:10px;">
      <div class="row" style="margin-top:16px;">
        <button id="saveProductBtn" class="btn" style="flex:1;">ğŸ’¾ Simpan</button>
        <button id="cancelProductBtn" class="btn btn-secondary" style="flex:1;">Batal</button>
      </div>
    </div>
  </div>

  <!-- Popup: Aksi Produk (+) -->
  <div id="productActionOverlay" class="overlay">
    <div class="popup">
      <h3>Aksi Produk</h3>
      <div class="row" style="margin-top:12px;flex-direction:column;gap:8px;">
        <button id="editBtn" class="btn btn-outline">âœï¸ Edit Produk</button>
        <button id="stockBtn" class="btn btn-outline">ğŸ“¦ Update Stok</button>
        <button id="deleteBtn" class="btn btn-outline">ğŸ—‘ï¸ Hapus Produk</button>
        <button id="orderBtn" class="btn btn-outline">ğŸ›’ Order Produk</button>
        <button id="closeActionsBtn" class="btn btn-secondary">Tutup</button>
      </div>
    </div>
  </div>

  <!-- Popup: Order Produk -->
  <div id="orderPromptOverlay" class="overlay">
    <div class="popup" id="orderPromptPopup">
      <h3>Order Produk</h3>
      <input id="orderQty" class="input" type="number" placeholder="Jumlah" style="margin-top:12px;">
      <div class="row" style="margin-top:12px;gap:8px;">
        <button class="btn-small btn-outline" data-unit="PCS">PCS</button>
        <button class="btn-small btn-outline" data-unit="BAL">BAL</button>
        <button class="btn-small btn-outline" data-unit="DUS">DUS</button>
      </div>
      <div class="row" style="margin-top:16px;">
        <button id="confirmOrderBtn" class="btn" style="flex:1;">OK</button>
        <button id="cancelOrderBtn" class="btn btn-secondary" style="flex:1;">Batal</button>
      </div>
    </div>
  </div>

  <!-- Popup: History Pesanan -->
  <div id="historyOverlay" class="overlay">
    <div class="popup">
      <h3>Riwayat Pesanan</h3>
      <div id="historyFullList" style="max-height:320px;overflow-y:auto;margin-top:10px;"></div>
      <div class="row" style="margin-top:16px;">
        <button id="clearHistoryBtn" class="btn btn-secondary" style="flex:1;">ğŸ—‘ï¸ Bersihkan</button>
        <button id="closeHistoryBtn" class="btn" style="flex:1;">Tutup</button>
      </div>
    </div>
  </div>
  <script>
  // ===============================
  // IndexedDB Setup
  // ===============================
  let db;
  const request = indexedDB.open("stoktokoDB", 1);
  request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("products")) {
      db.createObjectStore("products", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("cart")) {
      db.createObjectStore("cart", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("orders")) {
      db.createObjectStore("orders", { keyPath: "id", autoIncrement: true });
    }
    if (!db.objectStoreNames.contains("history")) {
      db.createObjectStore("history", { keyPath: "id", autoIncrement: true });
    }
  };
  request.onsuccess = e => { db = e.target.result; loadCategories(); loadCart(); loadOrders(); loadHistory(); };

  function tx(store, mode) { return db.transaction(store, mode).objectStore(store); }

  // ===============================
  // DOM Elements
  // ===============================
  const addProductBtn = document.getElementById("addProductBtn");
  const addProductOverlay = document.getElementById("addProductOverlay");
  const saveProductBtn = document.getElementById("saveProductBtn");
  const cancelProductBtn = document.getElementById("cancelProductBtn");
  const categoriesList = document.getElementById("categoriesList");
  const outOfStockBtn = document.getElementById("outOfStockBtn");

  const productActionOverlay = document.getElementById("productActionOverlay");
  const editBtn = document.getElementById("editBtn");
  const stockBtn = document.getElementById("stockBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const orderBtn = document.getElementById("orderBtn");
  const closeActionsBtn = document.getElementById("closeActionsBtn");

  const orderPromptOverlay = document.getElementById("orderPromptOverlay");
  const confirmOrderBtn = document.getElementById("confirmOrderBtn");
  const cancelOrderBtn = document.getElementById("cancelOrderBtn");

  const cartPage = document.getElementById("cartPage");
  const homePage = document.getElementById("homePage");
  const ordersPage = document.getElementById("ordersPage");
  const navHome = document.getElementById("navHome");
  const navOrders = document.getElementById("navOrders");

  const cartIconBtn = document.getElementById("cartIconBtn");
  const cartCountTag = document.getElementById("cartCountTag");
  const cartList = document.getElementById("cartList");
  const selectAllCart = document.getElementById("selectAllCart");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const deleteCheckedBtn = document.getElementById("deleteCheckedBtn");
  const backHomeBtn = document.getElementById("backHomeBtn");

  const custNameInput = document.getElementById("custNameInput");
  const custWaInput = document.getElementById("custWaInput");
  const custDateInput = document.getElementById("custDateInput");
  const custOrderInput = document.getElementById("custOrderInput");
  const addOrderBtn = document.getElementById("addOrderBtn");
  const orderList = document.getElementById("orderList");
  const openHistoryBtn = document.getElementById("openHistoryBtn");
  const historyList = document.getElementById("historyList");

  const historyOverlay = document.getElementById("historyOverlay");
  const historyFullList = document.getElementById("historyFullList");
  const clearHistoryBtn = document.getElementById("clearHistoryBtn");
  const closeHistoryBtn = document.getElementById("closeHistoryBtn");

  // ===============================
  // Popup Controls
  // ===============================
  function openPopup(el) { el.style.display = "flex"; }
  function closePopup(el) { el.style.display = "none"; }

  addProductBtn.onclick = () => { 
    document.getElementById("addEditTitle").textContent="Tambah Produk"; 
    openPopup(addProductOverlay); 
  };
  cancelProductBtn.onclick = () => closePopup(addProductOverlay);

  closeActionsBtn.onclick = () => closePopup(productActionOverlay);
  cancelOrderBtn.onclick = () => closePopup(orderPromptOverlay);

  // ===============================
  // Save Product
  // ===============================
  saveProductBtn.onclick = () => {
    const name = document.getElementById("productName").value.trim();
    const cat = document.getElementById("productCategory").value.trim();
    const stock = parseInt(document.getElementById("productStock").value || "0");
    const file = document.getElementById("productImage").files[0];

    if (!name || !cat) return alert("Lengkapi data produk!");
    if (file && file.size > 6*1024*1024) return alert("Gambar max 6MB");

    const reader = new FileReader();
    reader.onload = () => {
      const obj = { name, category: cat, stock, img: reader.result };
      tx("products","readwrite").add(obj).onsuccess = () => {
        closePopup(addProductOverlay); loadCategories();
        document.getElementById("productName").value="";
        document.getElementById("productCategory").value="";
        document.getElementById("productStock").value="";
        document.getElementById("productImage").value="";
      };
    };
    if (file) reader.readAsDataURL(file);
    else {
      const obj = { name, category: cat, stock, img:"" };
      tx("products","readwrite").add(obj).onsuccess = () => { 
        closePopup(addProductOverlay); loadCategories(); 
      };
    }
  };

  // ===============================
  // Load Categories + Products
  // ===============================
  function loadCategories() {
    categoriesList.innerHTML="";
    const cats={};
    tx("products").getAll().onsuccess=e=>{
      e.target.result.forEach(p=>{
        if (!cats[p.category]) cats[p.category]=[];
        cats[p.category].push(p);
      });
      Object.keys(cats).forEach(cat=>{
        const cDiv=document.createElement("div");
        cDiv.className="category";
        cDiv.innerHTML=`<div class="category-header">${cat}<span>â–¼</span></div>`;
        const pDiv=document.createElement("div");
        pDiv.className="category-products";
        cats[cat].forEach(prod=>{
          const row=document.createElement("div");
          row.className="product";
          row.innerHTML=`<img src="${prod.img||''}"><div class="product-info"><b>${prod.name}</b><br>Stok: ${prod.stock}</div><button class="plus">+</button>`;
          const plus=row.querySelector(".plus");
          plus.onclick=()=>{ currentProduct=prod; openPopup(productActionOverlay); };
          pDiv.appendChild(row);
        });
        cDiv.appendChild(pDiv);
        cDiv.querySelector(".category-header").onclick=()=>{ 
          pDiv.style.display=pDiv.style.display==="block"?"none":"block"; 
        };
        categoriesList.appendChild(cDiv);
      });
    };
  }

  // ===============================
  // Actions (+)
  // ===============================
  let currentProduct=null;
  editBtn.onclick=()=>{
    if(!currentProduct) return;
    document.getElementById("addEditTitle").textContent="Edit Produk";
    document.getElementById("productName").value=currentProduct.name;
    document.getElementById("productCategory").value=currentProduct.category;
    document.getElementById("productStock").value=currentProduct.stock;
    document.getElementById("productIdHidden").value=currentProduct.id;
    closePopup(productActionOverlay); openPopup(addProductOverlay);
  };
  stockBtn.onclick=()=>{
    const ns=prompt("Masukkan stok baru:",currentProduct.stock);
    if(ns!==null){ 
      currentProduct.stock=parseInt(ns);
      tx("products","readwrite").put(currentProduct).onsuccess=loadCategories;
    }
    closePopup(productActionOverlay);
  };
  deleteBtn.onclick=()=>{
    if(confirm("Hapus produk ini?")) 
      tx("products","readwrite").delete(currentProduct.id).onsuccess=loadCategories;
    closePopup(productActionOverlay);
  };
  orderBtn.onclick=()=>{ openPopup(orderPromptOverlay); };

  // ===============================
  // Order to Cart
  // ===============================
  let orderUnit="";
  document.querySelectorAll("#orderPromptOverlay [data-unit]").forEach(b=>{
    b.onclick=()=>{ orderUnit=b.dataset.unit; };
  });
  confirmOrderBtn.onclick=()=>{
    const qty=parseInt(document.getElementById("orderQty").value);
    if(!qty||!orderUnit) return alert("Isi jumlah dan unit!");
    const cartObj={ name:currentProduct.name, img:currentProduct.img, qty, unit:orderUnit };
    tx("cart","readwrite").add(cartObj).onsuccess=()=>{ 
      loadCart(); 
      closePopup(orderPromptOverlay); 
      closePopup(productActionOverlay); 
    };
  };

  // ===============================
  // Cart
  // ===============================
  function loadCart(){
    cartList.innerHTML="";
    tx("cart").getAll().onsuccess=e=>{
      const items=e.target.result;
      cartCountTag.textContent=items.length;
      items.forEach(i=>{
        const div=document.createElement("div");
        div.className="cart-item";
        div.innerHTML=`<input type="checkbox" class="cart-check" data-id="${i.id}"><img src="${i.img||''}"><div class="cart-info">${i.name}<br>${i.qty} ${i.unit}</div>`;
        cartList.appendChild(div);
      });
    };
  }
  selectAllCart.onchange=()=>{ 
    document.querySelectorAll(".cart-check").forEach(c=>c.checked=selectAllCart.checked); 
  };
  deleteCheckedBtn.onclick=()=>{
    document.querySelectorAll(".cart-check:checked").forEach(c=>{
      tx("cart","readwrite").delete(Number(c.dataset.id));
    });
    setTimeout(loadCart,300);
  };
  // === FIX: Checkout ke WhatsApp ===
  checkoutBtn.onclick=()=>{
    tx("cart").getAll().onsuccess = e => {
      const items = e.target.result;
      const checkedIds = Array.from(document.querySelectorAll(".cart-check:checked"))
        .map(c=>Number(c.dataset.id));
      if(checkedIds.length===0) return alert("Pilih barang dulu");

      let text = "ORDER :\n";
      items.filter(i => checkedIds.includes(i.id)).forEach(i=>{
        text += `â€¢ ${i.name}   ${i.qty} ${i.unit}\n`;
      });

      const encoded = encodeURIComponent(text);
      const waUrl = `https://wa.me/?text=${encoded}`;
      window.open(waUrl, "_blank");
    };
  };
  backHomeBtn.onclick=()=>showPage("home");

  // ===============================
  // Orders
  // ===============================
  custOrderInput.addEventListener("keydown",e=>{
    if(e.key==="Enter"){ e.preventDefault(); custOrderInput.value+="\nâ€¢ "; }
  });
  addOrderBtn.onclick=()=>{
    const name=custNameInput.value.trim();
    const wa=custWaInput.value.trim();
    const date=custDateInput.value.trim();
    const orders=custOrderInput.value.trim();
    if(!name||!date||!orders) return alert("Isi nama, tanggal, dan pesanan");
    const obj={ name, wa, date, orders, done:false, created:new Date().toLocaleString() };
    tx("orders","readwrite").add(obj).onsuccess=()=>{ 
      loadOrders(); 
      custNameInput.value=custWaInput.value=custDateInput.value=custOrderInput.value=""; 
    };
  };
  function loadOrders(){
    orderList.innerHTML="";
    tx("orders").getAll().onsuccess=e=>{
      e.target.result.forEach(o=>{
        const div=document.createElement("div");
        div.className="category";
        div.innerHTML=`<div class="category-header">${o.name} (${o.date})</div><div class="category-products"><pre>${o.orders}</pre><button class="btn-small">Selesai</button></div>`;
        const btn=div.querySelector("button");
        btn.onclick=()=>{
          o.done=true; o.finished=new Date().toLocaleString();
          tx("history","readwrite").add(o);
          tx("orders","readwrite").delete(o.id).onsuccess=()=>{ loadOrders(); loadHistory(); };
        };
        orderList.appendChild(div);
      });
    };
  }

  // ===============================
  // History
  // ===============================
  openHistoryBtn.onclick=()=>openPopup(historyOverlay);
  closeHistoryBtn.onclick=()=>closePopup(historyOverlay);
  clearHistoryBtn.onclick=()=>{ 
    tx("history","readwrite").clear().onsuccess=loadHistory; 
  };
  function loadHistory(){
    historyList.innerHTML="";
    historyFullList.innerHTML="";
    tx("history").getAll().onsuccess=e=>{
      e.target.result.forEach(h=>{
        const div=document.createElement("div");
        div.className="category";
        div.innerHTML=`<div class="category-header">${h.name} - ${h.date}</div>`;
        historyList.appendChild(div);
        const row=document.createElement("div");
        row.innerHTML=`<b>${h.name}</b> (${h.date})<br><pre>${h.orders}</pre><small>Selesai: ${h.finished}</small><hr>`;
        historyFullList.appendChild(row);
      });
    };
  }

  // ===============================
  // Navigation
  // ===============================
  function showPage(p){
    homePage.style.display=p==="home"?"block":"none";
    cartPage.style.display=p==="cart"?"block":"none";
    ordersPage.style.display=p==="orders"?"block":"none";
    navHome.classList.toggle("active",p==="home");
    navOrders.classList.toggle("active",p==="orders");
  }
  navHome.onclick=()=>showPage("home");
  navOrders.onclick=()=>showPage("orders");
  cartIconBtn.onclick=()=>showPage("cart");
  </script>
</body>
</html>